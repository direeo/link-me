// Prisma schema for LinkMe

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
    url      = env("DATABASE_URL")
}

// User model for authentication
model User {
    id            String    @id @default(cuid())
    email         String    @unique
    passwordHash  String
    name          String?
    emailVerified Boolean   @default(false)
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    // Relations
    verificationTokens  VerificationToken[]
    chatHistories       ChatHistory[]
    savedLearningPaths  SavedLearningPath[]
}


// Email verification tokens
model VerificationToken {
    id        String   @id @default(cuid())
    token     String   @unique
    userId    String
    expiresAt DateTime
    createdAt DateTime @default(now())

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([token])
    @@index([userId])
}

// Chat history for registered users
model ChatHistory {
    id        String   @id @default(cuid())
    userId    String
    messages  String // JSON string of chat messages
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

// Rate limiting entries
model RateLimitEntry {
    id          String   @id @default(cuid())
    key         String
    count       Int      @default(1)
    windowStart DateTime @default(now())
    blockedUntil DateTime?

    @@unique([key])
    @@index([key])
}

// Saved learning paths for users
model SavedLearningPath {
    id                String   @id @default(cuid())
    userId            String
    topic             String
    userLevel         String
    userGoal          String
    totalVideos       Int
    estimatedTotalTime String
    summary           String
    completionGoals   String   // JSON array of strings
    stages            String   // JSON of LearningStage[]
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    // Relations
    user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    videoProgress  VideoProgress[]

    @@index([userId])
}

// Video progress tracking
model VideoProgress {
    id              String   @id @default(cuid())
    userId          String
    learningPathId  String
    videoId         String   // YouTube video ID
    watched         Boolean  @default(false)
    watchedAt       DateTime?
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    // Relations  
    learningPath SavedLearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)

    @@unique([learningPathId, videoId])
    @@index([userId])
    @@index([learningPathId])
}

